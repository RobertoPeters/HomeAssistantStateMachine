@using Hasm.Components.Dialogs
@using Hasm.Models
@using Hasm.Services
@using Hasm.Services.Automations
@using Hasm.Services.Automations.Flow
@inject Services.DataService DataService
@inherits ResultDialogBase<StepVariableValue>

<RadzenTemplateForm @ref="Form" Data="@Model" TItem="StepVariableValue">
    <RadzenStack>
        <RadzenFormField Text="Name" Variant="@Variant.Outlined">
            <RadzenTextBox @bind-Value="@Model!.Name" Name="Name" spellcheck="false" />
        </RadzenFormField>
        <RadzenFormField Text="Variable name *" Variant="@Variant.Outlined">
            <ChildContent>
                <RadzenTextBox @bind-Value="@Model!.VariableName" Name="VariableName" spellcheck="false" />
            </ChildContent>
            <Helper>
                <RadzenRequiredValidator Component="VariableName" Text="This field is required" />
            </Helper>
        </RadzenFormField>
        <RadzenFormField Text="Client *" Variant="@Variant.Outlined">
            <ChildContent>
                <RadzenDropDown Data="Clients" @bind-Value="@Model!.ClientName" Name="ClientName" ValueProperty="@nameof(Client.Name)" TextProperty="@nameof(Client.Name)" />
            </ChildContent>
            <Helper>
                <RadzenRequiredValidator Component="ClientName" Text="This field is required" />
            </Helper>
        </RadzenFormField>
        <RadzenFormField Text="Is flow variabe" Variant="@Variant.Outlined">
            <RadzenRadioButtonList @bind-Value="@Model!.IsGlobalVariable" TValue="bool" class="rz-m-4 rz-mt-8">
                <Items>
                    <RadzenRadioButtonListItem Text="Yes" Value="true" />
                    <RadzenRadioButtonListItem Text="No" Value="false" />
                </Items>
            </RadzenRadioButtonList>
        </RadzenFormField>
        <RadzenFormField Text="Persistant" Variant="@Variant.Outlined">
            <RadzenRadioButtonList @bind-Value="@Model!.IsPersistant" TValue="bool" class="rz-m-4 rz-mt-8">
                <Items>
                    <RadzenRadioButtonListItem Text="Yes" Value="true" />
                    <RadzenRadioButtonListItem Text="No" Value="false" />
                </Items>
            </RadzenRadioButtonList>
        </RadzenFormField>
        <RadzenFormField Text="Data" Variant="@Variant.Outlined">
            <RadzenTextBox @bind-Value="@Model!.Data" Name="Data" spellcheck="false" />
        </RadzenFormField>
        <RadzenFormField Text="Mocking values" Variant="@Variant.Outlined">
            <RadzenTextBox @bind-Value="@Model!.MockingValues" Name="MockingValues" spellcheck="false" Placeholder="[0, 10]" />
        </RadzenFormField>
        <RadzenFormField Text="Payload on start" Variant="@Variant.Outlined">
            <RadzenRadioButtonList @bind-Value="@Model!.PayloadOnStart" TValue="bool" class="rz-m-4 rz-mt-8">
                <Items>
                    <RadzenRadioButtonListItem Text="Yes" Value="true" />
                    <RadzenRadioButtonListItem Text="No" Value="false" />
                </Items>
            </RadzenRadioButtonList>
        </RadzenFormField>
    </RadzenStack>
    <RadzenButton ButtonType="ButtonType.Button" Text="OK" Click="@OnSubmit" />
</RadzenTemplateForm>


@code {
    protected override bool ShowClose => true;
    protected override bool IsPersistent => false;
    protected override bool CloseDialogOnOverlayClick => true;
    protected override int? WidthInPixels => 1400;

    [Parameter]
    public StepVariableValue? Step { get; set; }

    [Parameter]
    public Automation? Automation { get; set; }


    private StepVariableValue? Model;
    private RadzenTemplateForm<StepVariableValue>? Form;
    private List<Client>? Clients;

    protected override void OnInitialized()
    {
        Clients = DataService.GetClients();
        if (Step == null)
        {
            Step = new StepVariableValue();
            Step.StepData.Type = Step.GetType();
            Step.StepData.HasInput = false;
            Step.Initialize();
        }
        Model = Step.CopyObject();

        base.OnInitialized();
    }

    void OnSubmit()
    {
        Form!.EditContext.Validate();
        if (Form.IsValid)
        {
            Close(Model);
        }
    }

}
